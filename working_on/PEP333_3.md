---
layout: post
title: "WSGI web服务网关接口(3)"
date: 2017-12-24 10:20:15 +0800
comments: true
categories: python
tags: [python,wsgi,translation,PEP]
---

> 本文译自：https://www.python.org/dev/peps/pep-0333
>
> 前一部分内容请查看：http://10111000.com/2017/12/22/PEP333_1/
>
> **tips**: 以下， 服务端代指服务端和网关， 框架端代指应用端和框架端

#### 缓冲与流

一般来说，应用程序会通过缓冲其输出（适度的大小）并一次性全部输出来实现最大的吞吐量。这是现有框架很常见的一种方法，比如在Zope中，输出被缓存在一个StringIO的对象或类似的对象中，并随着响应头一起传输给客户端。

在WSGI中相应的方法是将包含响应主体的单元素可迭代对象（比如列表）作为一个字符串返回，对于绝大多数的应用程序来说，这是推荐的方法，它可以很容易的实现HTML文本在内存中的渲染。

对于大文件，或者是特别指明需要利用HTTP流的（比如服务端推送），框架端可能需要更小块的输出（避免一次加载大文件进入内存）。有时候也会出现一部分响应很耗时的情况，这个时候，我们可以选择提前将已经可以响应的部分先发出去。

在这些情况下，应用程序通常会返回一个迭代器（通常是一个生成器迭代器），以逐块方式生成输出。这些块在某些情况下也可能会被分割开来以用来多块传输（服务端推送）或先于耗时任务前发送（比如读取硬盘上的某一块的文件）。

服从WSGI规范的服务器、网关和中间件不能延误任何块的传输；它们必须保证完整的把整个块传送给客户端，或者保证框架端在产生下个块时，持续的进行传输。服务端和中间件可以通过以下三个方法之一来提供保证：

1. 在把控制权交给框架前，把整个块发送给操作系统（并请求清空所有的O/S缓冲）。
2. 用另外一个线程来保证应用程序在生成下个块时，持续的进行传输。
3. 发送整个块给服务端（仅适用于中间件）。

通过这些保证，使得应用程序不会在任意一个时刻的输出会停滞。这对于多路服务推送功能的实现是至关重要的。多个块边界之间的数据应该完整的传送给客户端。

##### 块边界的中间件处理

为了更好的支持异步框架和服务端，中间件不能阻止块的迭代去等待框架端的多个返回值。如果中间件需要在产生输出之前累积来自应用程序的数据，那么必须产生一个空字符串。

换个方式来理解的话，应用程序产生一个值，中间件也必须产生到一个值。如果中间件不能产生任何值的话，就产生一个空的字符串。

这个需求是为了确保异步应用程序和服务端可以在一起确定，是否需要减少同时跑给定数量的应用程序实例的线程个数。

还要注意，这个需求意味着中间件必须在应用程序返回一个可迭代时立即返回一个迭代。它也禁止中间件直接用write()函数来传输底层应用程序返回的数据。中间件仅能使用它父服务端提供的write方法，而应用程序则使用由中间件提供的write方法。

##### 可调用的write()函数

一些现有的应用程序框架API以一种不同的方式提供了无缓冲数据的输出。比如，它们提供了write方法和函数来支持无缓冲块数据的输出，或者提供了write方法写入数据到缓冲区，以及flush机制来清空缓冲区。

不幸的是，这些API并没有实现应用程序端返回可迭代对象的功能，除非使用了线程或者其他特殊的机制。

因此，为了使得现有的框架继续使用现有的API，WSGI规范必须包含特殊的write方法，并由start_response方法返回。

如果可以避免的话，新的应用程序和框架不应该再继续使用write方法。write方法仅仅是提供了一种比较hack方式给那些现在迫切需要使用的API，一般来说，应用程序的输出应该是一个可迭代的对象，这也使得服务端可以在同一个线程中交错的执行其他的任务，潜在的为服务端提供了更好的吞吐量。

write方法由start_response方法返回，它只接收一个参数：作为响应主体的一个字符串，我们可以把它看作是已经迭代输出以后的结果。换句话说，在write方法返回前，它必须保证其是需要传给用户的完整数据，或者在应用程序继续进行时被缓冲并用于传输。

一个应用程序必须返回可迭代对象，即使使用write方法来产生所有或者部分的响应主体。返回的可迭代对象可能为空，但是一旦产生非空字符串，输出必须可以被服务端正常处理（例如：它必须被立即发送或者放入队列），应用程序不能在它们返回的迭代器中调用write方法。因此，在所有字符串都被传给write方法并发送给客户端后，由迭代对象产生的任何字符串也被传输。